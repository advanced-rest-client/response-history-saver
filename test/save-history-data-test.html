<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <link rel="import" href="../../app-pouchdb/pouchdb.html">
    <link rel="import" href="../response-history-saver.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <response-history-saver></response-history-saver>
      </template>
    </test-fixture>

    <script>
    /* global PouchDB */
    suite('Saving history data', function() {

      // var string = '********';
      let element;
      let request;
      let response;
      let timings;
      function initVariables() {
        element = fixture('basic');
        request = {
          url: 'https://domain.com/path/?query=value',
          method: 'POST',
          payload: 'hello world',
          headers: 'content-type: text/plain\ncontent-length: 11'
        };
        response = {
          status: 218,
          statusText: 'OK TEST',
          headers: 'x-test: true',
          payload: 'test-response'
        };
        timings = {
          connect: 2.008,
          receive: 24.1769,
          send: 96.1234,
          ssl: 11,
          wait: 54.512,
          startTime: 1499427973215
        };
      }

      suite('_createHistoryDataModel()', function() {
        let model;
        setup(function() {
          initVariables();
          model = element._createHistoryDataModel(request, response, timings);
        });

        test('Model has _id', function() {
          assert.typeOf(model._id, 'string');
        });

        test('_id has no "undefined" properties', function() {
          assert.isTrue(model._id.indexOf('undefined') === -1);
        });

        test('Does not contain _rev', function() {
          assert.isUndefined(model._rev);
        });

        test('Has timings', function() {
          assert.typeOf(model.timings, 'object');
        });

        test('Timings are computed according to HAR 1.2 spec', function() {
          const allowedKeys = ['blocked', 'dns', 'connect', 'send', 'wait',
            'receive', 'ssl'];
          const keys = Object.keys(model.timings);
          const otherKeys = keys.some((key) => allowedKeys.indexOf(key) === -1);
          assert.isFalse(otherKeys);
        });

        test('Timings have values', function() {
          const keys = Object.keys(model.timings);
          const otherKeys = keys.some((key) => model.timings[key] === -1);
          assert.isFalse(otherKeys);
        });

        test('Has totalTime', function() {
          assert.typeOf(model.totalTime, 'number', 'totalTime is a number');
          assert.isAbove(model.totalTime, -1, 'totalTime is greather than -1');
        });

        test('Has created', function() {
          assert.typeOf(model.created, 'number', 'totalTime is a number');
          assert.equal(model.created, timings.startTime, 'totalTime equals passed timings value');
        });

        test('Has request', function() {
          assert.typeOf(model.request, 'object');
        });

        test('Has request.headers', function() {
          assert.typeOf(model.request.headers, 'string');
        });

        test('Has request.payload', function() {
          assert.typeOf(model.request.payload, 'string');
        });

        test('Has request.url', function() {
          assert.typeOf(model.request.url, 'string');
          assert.equal(model.request.url, request.url);
        });

        test('Has request.method', function() {
          assert.typeOf(model.request.method, 'string');
          assert.equal(model.request.method, request.method);
        });

        test('Has response', function() {
          assert.typeOf(model.response, 'object');
        });

        test('Has response.statusCode', function() {
          assert.typeOf(model.response.statusCode, 'number');
          assert.equal(model.response.statusCode, response.status);
        });

        test('Has response.statusText', function() {
          assert.typeOf(model.response.statusText, 'string');
          assert.equal(model.response.statusText, response.statusText);
        });

        test('Has response.headers', function() {
          assert.typeOf(model.response.headers, 'string');
        });

        test('Has response.payload', function() {
          assert.typeOf(model.response.payload, 'string');
        });

        test('Has stats', function() {
          assert.typeOf(model.stats, 'object');
        });

        test('Has stats.request', function() {
          assert.typeOf(model.stats.request, 'object');
        });

        test('Has stats.request.headersSize', function() {
          assert.typeOf(model.stats.request.headersSize, 'number');
          assert.equal(model.stats.request.headersSize, 43);
        });

        test('Has stats.request.requestPayloadSize', function() {
          assert.typeOf(model.stats.request.payloadSize, 'number');
          assert.equal(model.stats.request.payloadSize, 11);
        });

        test('Has stats.response', function() {
          assert.typeOf(model.stats.response, 'object');
        });

        test('Has stats.response.headersSize', function() {
          assert.typeOf(model.stats.response.headersSize, 'number');
          assert.equal(model.stats.response.headersSize, 12);
        });

        test('Has stats.response.requestPayloadSize', function() {
          assert.typeOf(model.stats.response.payloadSize, 'number');
          assert.equal(model.stats.response.payloadSize, 13);
        });
      });

      suite('_createHistoryDataModel() with payload', function() {
        let model;
        setup(function() {
          element = fixture('basic');
          request = {
            url: 'https://domain.com/path/?query=value',
            method: 'POST',
            payload: '********',
            headers: 'content-type: plain/text\ncontent-length: 8'
          };
          response = {
            status: 218,
            statusText: 'OK TEST',
            payload: '********',
            headers: 'content-type: plain/text\ncontent-length: 8\nconnection: close'
          };
          model = element._createHistoryDataModel(request, response);
        });

        test('Has stats.request.headersSize', function() {
          assert.typeOf(model.stats.request.headersSize, 'number');
          assert.equal(model.stats.request.headersSize, 42);
        });

        test('Has stats.request.requestPayloadSize', function() {
          assert.typeOf(model.stats.request.payloadSize, 'number');
          assert.equal(model.stats.request.payloadSize, 8);
        });

        test('Has stats.response.headersSize', function() {
          assert.typeOf(model.stats.response.headersSize, 'number');
          assert.equal(model.stats.response.headersSize, 60);
        });

        test('Has stats.response.requestPayloadSize', function() {
          assert.typeOf(model.stats.response.payloadSize, 'number');
          assert.equal(model.stats.response.payloadSize, 8);
        });
      });

      suite('_createHistoryDataModel()', function() {
        suiteTeardown(function() {
          return new PouchDB('history-data').destroy();
        });

        setup(function() {
          initVariables();
        });

        test('Saves model to the datastore', function() {
          return element._saveHistoryData(request, response, timings)
          .then(function(response) {
            assert.isTrue(response.ok);
          });
        });
      });
    });
    </script>

  </body>
</html>
