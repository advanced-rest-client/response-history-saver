<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>

  </head>
  <body>
    <request-model></request-model>
    <test-fixture id="basic">
      <template>
        <response-history-saver></response-history-saver>
      </template>
    </test-fixture>

    <script type="module">
    import '../response-history-saver.js';
    import '../../../@advanced-rest-client/arc-models/request-model.js';
    import {DataGenerator} from '../../../@advanced-rest-client/arc-data-generator/arc-data-generator.js';
    import sinon from '../../../sinon/pkg/sinon-esm.js';
    suite('Saving history request data', function() {
      function historyHandler(e) {
        e.preventDefault();
        e.detail.result = Promise.resolve();
      }

      suiteSetup(() => {
        document.body.addEventListener('save-history', historyHandler);
      });

      suiteTeardown(function() {
        document.body.removeEventListener('save-history', historyHandler);
        return DataGenerator.destroyHistoryData();
      });

      let element;
      let detail;
      function initVariables() {
        element = fixture('basic');
        detail = {
          isXhr: false,
          request: {
            url: 'http://serwisy.gazeta.pl/aliasy/rss_hp/wiadomosci.xml',
            method: 'GET',
            headers: 'accept: application/xml',
            id: 'be2d8f61-df5a-4caa-bae3-c7a3ded161c4'
          },
          isError: false,
          response: {
            status: 200,
            statusText: 'OK',
            headers: 'Date: Thu, 18 Apr 2019 20:20:42 GMT\r\n' +
              'Server: Apache\r\nLast-Modified: Tue, 23 Jun 2015 09:50:01 GMT\r\n' +
              'Accept-Ranges: bytes\r\nContent-Length: 726\r\nVary: Accept-Encoding,' +
              'User-Agent\r\nContent-Type: application/xml',
            url: 'http://serwisy.gazeta.pl/aliasy/rss_hp/wiadomosci.xml',
            payload: 'test-payload',
            stats: {
              connect: 269.00000000023283,
              receive: 0.8000000088941306,
              send: 0.29999998514540493,
              wait: 271.8999999924563,
              dns: 1.0999999940395355,
              ssl: -1
            }
          },
          sentHttpMessage: 'GET /aliasy/rss_hp/wiadomosci.xml HTTP/1.1\r\nHost: serwisy.gazeta.pl\r\n\r\n',
          loadingTime: 543.0999999807682,
          timing: {
            dns: 1.0999999940395355,
            connect: 269.00000000023283,
            receive: 0.8000000088941306,
            send: 0.29999998514540493,
            ssl: -1,
            wait: 271.8999999924563
          },
          id: 'be2d8f61-df5a-4caa-bae3-c7a3ded161c4'
        };
      }

      suite('_afterRequestHandler()', function() {
        setup(function() {
          initVariables();
        });

        function dispatch() {
          const e = new CustomEvent('api-response', {
            bubbles: true,
            detail
          });
          document.body.dispatchEvent(e);
        }

        test('Eventually calls saveHistory()', function(done) {
          const spy = sinon.spy(element, 'saveHistory');
          dispatch();
          setTimeout(() => {
            assert.isTrue(spy.called);
            done();
          });
        });

        test('Inserts data into the store', function(done) {
          dispatch();
          setTimeout(() => {
            // Some extra time to insert data into the store.
            setTimeout(() => {
              element._dbData.allDocs({
                include_docs: true
              })
              .then((docs) => {
                const doc = docs.rows.pop().doc;
                assert.equal(doc.totalTime, 541.9999999867287);
                assert.deepEqual(doc.timings, {
                  connect: 269.00000000023283,
                  receive: 0.8000000088941306,
                  send: 0.29999998514540493,
                  ssl: -1,
                  wait: 271.8999999924563
                });
                assert.deepEqual(doc.request, {
                  headers: 'accept: application/xml',
                  method: 'GET',
                  payload: '',
                  url: 'http://serwisy.gazeta.pl/aliasy/rss_hp/wiadomosci.xml'
                });
                assert.deepEqual(doc.response, {
                  headers: 'Date: Thu, 18 Apr 2019 20:20:42 GMT\r\n' +
                    'Server: Apache\r\nLast-Modified: Tue, 23 Jun 2015 09:50:01 GMT\r\n' +
                    'Accept-Ranges: bytes\r\nContent-Length: 726\r\nVary: Accept-Encoding,' +
                    'User-Agent\r\nContent-Type: application/xml',
                  payload: 'test-payload',
                  statusCode: 200,
                  statusText: 'OK'
                });
                assert.deepEqual(doc.stats.request, {
                  headersSize: 23,
                  payloadSize: 0
                });
                assert.deepEqual(doc.stats.response, {
                  headersSize: 205,
                  payloadSize: 12
                });
                done();
              })
              .catch((cause) => {
                done(cause);
              });
            }, 100);
          });
        });
      });
    });
    </script>

  </body>
</html>
